<html><head><title>Test</title></head>
<body></body>
<script>

var iframe = document.createElement('iframe');
iframe.src = 'data:text/html;charset=utf-8,' + encodeURI("");
document.body.appendChild(iframe);
console.log('iframe.contentWindow =', iframe.contentWindow);

iframe.variables = {}


function qmlToHtml(url) {
    if (url.endsWith(".qml")) {
        return url.substring(0, url.length - 3) + "html"
    }
    else {
        return url
    }
}

function show_page(url) {
    console.log("Showing page " + url);
    iframe.src = encodeURI(url);
    document.body.appendChild(iframe);
}


namespaces = []
gui_ws = null;

// Temporary, will be removed in core and specified port will be used
// Connect to main bus to get the GUI port
ws = new WebSocket("ws://localhost:8181/core")

ws.onmessage = function(event) {
    msg = JSON.parse(event.data)
    if (msg.type == "mycroft.gui.port") {
        console.log("connectiong to gui at " + msg.data["port"])
        gui_ws = new WebSocket("ws://localhost:" + msg.data["port"] + "/gui")
        gui_ws.onmessage = function(event) {
            gui_msg = JSON.parse(event.data)
            switch (gui_msg.type) {
                case "mycroft.session.set": 
                    // Set a variable
                    console.log("Adding new variable")
                    console.log(gui_msg.data)
                    namespace = gui_msg.data.namespace
                    iframe.variables[namespace] = msg.data
                    break
                case "mycroft.session.list.insert":
                    // Insert a new namespace at the top of the GUI page stack
                    console.log("Adding new namespace")
                    console.log(event.data)
                    skill = gui_msg.data[0]['skill_id']
                    namespaces.unshift([skill, []])
                    break
                case "mycroft.gui.list.insert":
                    // Insert new page in the namespace
                    // TODO: Insert multiple pages at the correct position
                    console.log("Adding new page")
                    console.log(gui_msg.data)
                    page = gui_msg.data[0]['url']
                    pos = gui_msg.position
                    namespaces[0][1].splice(pos, 0, page)
                    show_page(qmlToHtml(page))
                    break
                case "mycroft.session.list.move":
                    // TODO
                    // Move the namespace at pos to the another position
                    // Initial implementation, always moves to top
                    // Called when skill is activated
                    break
                case "mycroft.events.triggered":
                    // TODO
                    // Used to switch page within currently active namespace
                    skill = gui_msg['namespace']
                    pos = gui_msg.data.number
                    break
                default:
                    // Log unhandled messages
                    console.log("Unhandled message type: " + gui_msg.type)
                    break
            }
        }
    }
}

ws.onopen = function (event) {
    // Announce to trigger send of "mycroft.gui.port" message with gui port
    ws.send("{\"type\": \"mycroft.gui.connected\", \"data\": {}}")
}
</script>
</html>
